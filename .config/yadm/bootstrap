#!/bin/bash

system_type=$(uname -s)

# ============================================
# Clone dotfiles-private if not present
# ============================================
PRIVATE_REPO="git@github.com:markbiek/dotfiles-private.git"
PRIVATE_DIR="$HOME/dev/dotfiles-private"

if [[ ! -d "$PRIVATE_DIR" ]]; then
    echo "Cloning dotfiles-private..."
    mkdir -p "$HOME/dev"
    git clone "$PRIVATE_REPO" "$PRIVATE_DIR"
fi

# Symlink secrets file
if [[ -f "$PRIVATE_DIR/secrets/env" ]]; then
    echo "Linking secrets..."
    ln -sf "$PRIVATE_DIR/secrets/env" "$HOME/.secrets"
else
    echo "Warning: $PRIVATE_DIR/secrets/env not found"
fi

# ============================================
# Clone and install tms (tmux session manager)
# ============================================
TMS_REPO="git@github.com:markbiek/tms.git"
TMS_DIR="$HOME/dev/personal/tms"

if [[ ! -d "$TMS_DIR" ]]; then
    echo "Cloning tms..."
    mkdir -p "$HOME/dev/personal"
    git clone "$TMS_REPO" "$TMS_DIR"
fi

# Run tms install script
if [[ -f "$TMS_DIR/install.sh" ]]; then
    echo "Installing tms..."
    "$TMS_DIR/install.sh"
fi

# ============================================
# macOS-specific setup
# ============================================
if [[ $OSTYPE == darwin* ]]; then

    # Install homebrew if missing
    if ! command -v brew >/dev/null 2>&1; then
        echo "Installing homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Run brew bundle
    if [ -f "$HOME/.Brewfile" ]; then
        echo "Updating homebrew bundle..."
        brew bundle --global
    fi

fi

echo "Bootstrap complete!"
